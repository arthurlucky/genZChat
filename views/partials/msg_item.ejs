<% 
    const isMe = msg.userId === user.id; 
    const tickColor = msg.readBy && msg.readBy.length > 1 ? 'text-blue-400' : 'text-gray-500';
    
    // STRATEGI BARU: 
    // align-items pada parent + align-self pada anak = AUTO SHRINK (Pasti mengecil)
    const alignParent = isMe ? 'items-end' : 'items-start';
    const alignSelf = isMe ? 'flex-end' : 'flex-start';
    const borderRadius = isMe ? 'rounded-2xl rounded-tr-sm' : 'rounded-2xl rounded-tl-sm';
    const bubbleColor = isMe ? 'bg-primary-600 text-white' : 'bg-dark-800 text-gray-100 border border-dark-700';
%>

<div class="message-row w-full flex <%= isMe ? 'justify-end' : 'justify-start' %> mb-2 relative select-none group" 
     id="msg-<%= msg.id %>" 
     data-id="<%= msg.id %>" 
     data-username="<%= msg.username %>" 
     data-type="<%= msg.type %>" 
     data-content="<%= msg.content.replace(/"/g, '&quot;') %>">

    <div class="reply-icon absolute top-1/2 -translate-y-1/2 <%= isMe ? 'right-full mr-4' : 'left-full ml-4' %> opacity-0 transition-opacity duration-200 text-primary-500 z-0">
        <div class="bg-dark-800 p-2 rounded-full border border-dark-700 shadow-xl">
            <i data-lucide="reply" class="w-5 h-5"></i>
        </div>
    </div>

    <div class="message-content relative z-10 flex max-w-[85%] <%= isMe ? 'flex-row-reverse' : 'flex-row' %> items-end gap-2 transition-transform will-change-transform">
        
        <% if(!isMe) { %>
            <img src="<%= msg.pic %>" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full mb-1 border border-dark-700 object-cover shrink-0">
        <% } %>

        <div class="flex flex-col <%= alignParent %> w-auto min-w-0">
            
            <% if(!isMe) { %> 
                <span class="text-[10px] text-primary-400 font-bold ml-1 mb-0.5"><%= msg.username %></span> 
            <% } %>

            <div class="relative px-3 py-2 shadow-sm overflow-hidden group/bubble <%= borderRadius %> <%= bubbleColor %>"
                 style="align-self: <%= alignSelf %>; width: auto; max-width: 100%; display: inline-block; word-wrap: break-word;">
                
                <button onclick="openMenu(event, '<%= msg.id %>', <%= isMe %>, '<%= msg.type %>', `<%= msg.content.replace(/`/g, '\\`') %>`, '<%= msg.username %>')" 
                    class="absolute top-1 right-1 opacity-0 group-hover/bubble:opacity-100 transition p-1 bg-black/20 rounded hover:bg-black/40 text-white z-20 hidden sm:block">
                    <i data-lucide="chevron-down" class="w-3 h-3"></i>
                </button>

                <% if(msg.replyTo && !msg.deleted) { %>
                    <div class="mb-1 p-1.5 pl-2 border-l-2 border-white/50 bg-black/10 rounded text-[10px] cursor-pointer hover:bg-black/20 transition min-w-[100px]"
                         onclick="scrollToMessage('<%= msg.replyTo.id %>')">
                        <span class="font-bold opacity-80"><%= msg.replyTo.username %></span>
                        <p class="truncate opacity-70"><%= msg.replyTo.type === 'text' ? msg.replyTo.content : '['+msg.replyTo.type+']' %></p>
                    </div>
                <% } %>

                <div id="content-<%= msg.id %>" class="text-sm sm:text-base leading-relaxed break-words whitespace-pre-wrap">
                    <% if(msg.deleted) { %>
                        <span class="italic opacity-50 flex items-center gap-1 text-xs"><i data-lucide="ban" class="w-3 h-3"></i> Pesan dihapus</span>
                    <% } else { %>
                        <% if(msg.type === 'text') { %>
                            <%- msg.content %>
                        <% } else if(msg.type === 'image') { %>
                            <img src="<%= msg.content %>" class="rounded-lg max-h-60 w-full object-cover cursor-pointer" onclick="window.open(this.src)">
                        <% } else if(msg.type === 'video') { %>
                            <video src="<%= msg.content %>" controls class="rounded-lg max-h-60 w-full bg-black"></video>
                        <% } else if(msg.type === 'audio') { %>
                            <audio src="<%= msg.content %>" controls class="w-[200px] mt-1"></audio>
                        <% } else { %>
                            <a href="<%= msg.content %>" target="_blank" class="flex items-center gap-2 bg-black/20 p-2 rounded-lg hover:bg-black/30">
                                <div class="bg-white/10 p-1.5 rounded"><i data-lucide="file" class="w-4 h-4"></i></div>
                                <div><p class="text-xs font-bold truncate max-w-[150px]"><%= msg.fileName %></p></div>
                            </a>
                        <% } %>
                    <% } %>
                </div>

                <% if(msg.reactions && Object.keys(msg.reactions).length > 0) { %>
                    <div class="flex gap-1 mt-1 flex-wrap justify-end">
                        <% for(let [emoji, users] of Object.entries(msg.reactions)) { %>
                            <span class="reaction-badge scale-90 origin-right"><%= emoji %> <%= users.length %></span>
                        <% } %>
                    </div>
                <% } %>
            </div>

            <div class="flex items-center gap-1 mt-0.5 ml-1 select-none">
                <span class="text-[9px] text-gray-500 opacity-70"><%= msg.time %></span>
                <% if(msg.edited) { %> <span class="text-[8px] text-gray-500 opacity-50">(edited)</span> <% } %>
                <% if(isMe && !msg.deleted) { %> <i data-lucide="check-check" class="w-3 h-3 <%= tickColor %> check-icon"></i> <% } %>
            </div>
        </div>
    </div>
</div>
