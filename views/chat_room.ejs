<%- include('partials/header') %>
<script src="/socket.io/socket.io.js"></script>

<div class="flex flex-col h-[100dvh] bg-dark-900 w-full sm:max-w-2xl sm:mx-auto relative shadow-2xl sm:border-x sm:border-dark-700 overflow-hidden">
    
    <div class="h-16 flex items-center justify-between px-4 glass z-50 shrink-0 backdrop-blur-md relative border-b border-white/5">
        <div class="flex items-center gap-3 cursor-pointer select-none" onclick="openInfoModal()">
            <a href="/chat" class="p-2 -ml-2 text-gray-300 hover:text-white rounded-full hover:bg-white/5 transition" onclick="event.stopPropagation()">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </a>
            <div class="relative">
                <img src="<%= roomIcon %>" class="w-10 h-10 rounded-full border border-dark-700 object-cover bg-dark-800">
                <% if(room.type === 'private' && targetUser) { %>
                    <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-dark-900 transition-colors duration-300 <%= targetUser.isOnline ? 'bg-green-500' : 'bg-transparent' %>"></div>
                <% } %>
            </div>
            <div class="flex flex-col justify-center overflow-hidden">
                <h1 class="font-bold text-white text-base leading-tight truncate w-40 sm:w-64"><%= roomName %></h1>
                <div class="flex items-center gap-2">
                    <p id="subHeader" class="text-xs text-gray-400 truncate">
                        <%= room.type === 'group' ? `${members.length} anggota` : (targetUser && targetUser.isOnline ? 'Online' : 'Offline') %>
                    </p>
                    <% if(room.settings && room.settings.expiresIn > 0) { %>
                        <span class="text-[10px] text-yellow-500 flex items-center gap-0.5"><i data-lucide="clock" class="w-3 h-3"></i> <%= room.settings.expiresIn / 3600000 %>j</span>
                    <% } %>
                </div>
                <p id="typingIndicator" class="text-xs text-primary-400 font-medium hidden animate-pulse">sedang mengetik...</p>
            </div>
        </div>
        
        <button class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-white/5 transition" onclick="openInfoModal()">
            <i data-lucide="more-vertical" class="w-6 h-6"></i>
        </button>
    </div>

    <div id="pinnedBar" class="<%= pinnedMessage ? 'flex' : 'hidden' %> absolute top-16 left-0 right-0 bg-dark-800/95 backdrop-blur-md border-b border-dark-700 p-2 px-4 z-40 items-center justify-between cursor-pointer animate-slide-in-top" onclick="scrollToPinned()">
        <div class="flex flex-col overflow-hidden">
            <span class="text-[10px] text-primary-400 font-bold uppercase tracking-wider flex items-center gap-1">
                <i data-lucide="pin" class="w-3 h-3"></i> Pesan Tersemat
            </span>
            <p id="pinnedContent" class="text-xs text-white truncate font-medium">
                <%= pinnedMessage ? (pinnedMessage.type === 'text' ? pinnedMessage.content : 'Media File') : '' %>
            </p>
        </div>
        <% if(myRole === 'admin' || myRole === 'moderator') { %>
            <button onclick="unpinMessage(event)" class="text-gray-500 hover:text-red-400 p-1.5 rounded-full hover:bg-dark-700 transition">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        <% } %>
    </div>

    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-1 pb-4 scroll-smooth overscroll-contain bg-dark-900 transition-all duration-300" 
         style="padding-top: <%= pinnedMessage ? '60px' : '16px' %>; touch-action: pan-y;">
        <% room.messages.forEach(msg => { %>
            <% const isMe = msg.userId === user.id; %>
            
            <% if(msg.type === 'system') { %>
                <div class="flex justify-center my-4 w-full px-4">
                    <div class="bg-dark-800/80 backdrop-blur-sm text-gray-400 text-[10px] px-3 py-1.5 rounded-full border border-dark-700 font-medium tracking-wide shadow-sm text-center leading-relaxed max-w-[85%]">
                        <%= msg.content %>
                    </div>
                </div>
            <% } else { %>
                <div class="message-row w-full flex <%= isMe ? 'justify-end' : 'justify-start' %> mb-2 relative select-none group" 
                     onclick="openMsgOption(this, '<%= msg.id %>', '<%= msg.content.replace(/'/g, "\\'") %>', '<%= msg.type %>', '<%= msg.username %>')">
                    
                    <div class="message-content relative z-10 flex max-w-[95%] <%= isMe ? 'flex-row-reverse' : 'flex-row' %> items-end gap-2">
                        <% if(!isMe) { %>
                            <img src="<%= msg.pic %>" class="w-6 h-6 rounded-full mb-1 border border-dark-700 object-cover shrink-0">
                        <% } %>
                        
                        <div class="flex flex-col <%= isMe ? 'items-end' : 'items-start' %> min-w-0 flex-1">
                            <% if(!isMe) { %>
                                <span class="text-[10px] text-primary-400 font-bold ml-1 mb-0.5"><%= msg.username %></span>
                            <% } %>
                            
                            <div class="relative px-3 py-2 shadow-sm <%= isMe ? 'rounded-2xl rounded-tr-sm bg-primary-600 text-white' : 'rounded-2xl rounded-tl-sm bg-dark-800 text-gray-100 border border-dark-700' %> w-fit max-w-full break-words">
                                <% if(msg.replyTo) { %>
                                    <div class="mb-1 p-1.5 pl-2 border-l-2 border-white/50 bg-black/10 rounded text-[10px]">
                                        <span class="font-bold opacity-80"><%= msg.replyTo.username %></span>
                                        <p class="truncate opacity-70"><%= msg.replyTo.content %></p>
                                    </div>
                                <% } %>
                                
                                <% if(msg.type === 'text') { %>
                                    <div class="text-sm leading-relaxed whitespace-pre-wrap"><%= msg.content %></div>
                                <% } else if(msg.type === 'image') { %>
                                    <img src="<%= msg.content %>" onclick="event.stopPropagation(); viewImage('<%= msg.content %>')" class="rounded-lg max-h-60 w-full object-cover cursor-pointer hover:opacity-90 transition">
                                <% } else if(msg.type === 'audio') { %>
                                    <audio src="<%= msg.content %>" controls class="w-[200px]"></audio>
                                <% } else { %>
                                    <a href="<%= msg.content %>" target="_blank" class="flex items-center gap-2 underline text-xs">File: <%= msg.fileName %></a>
                                <% } %>
                            </div>
                            
                            <span class="text-[9px] text-gray-500 opacity-70 mt-0.5 ml-1 flex gap-1 items-center">
                                <%= msg.time %> 
                                <% if(isMe) { %> <i data-lucide="check-check" class="w-3 h-3 text-gray-500"></i> <% } %>
                            </span>
                        </div>
                    </div>
                </div>
            <% } %>
        <% }) %>
        <div class="h-2"></div>
    </div>

    <div id="previewBar" class="hidden absolute bottom-[80px] left-3 right-3 bg-dark-800/95 backdrop-blur-xl border border-dark-700 rounded-2xl p-3 z-30 shadow-2xl border-l-4 border-l-primary-500 animate-slide-up flex justify-between items-center">
        <div class="flex flex-col min-w-0 pr-4">
            <span class="text-xs font-bold text-primary-400 mb-0.5">Membalas...</span>
            <p id="previewText" class="text-xs text-gray-300 truncate italic">Konten</p>
        </div>
        <button onclick="cancelAction()" class="p-2 text-gray-400 hover:text-white rounded-full hover:bg-dark-700 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>

    <div id="inputArea" class="p-3 bg-dark-900/90 backdrop-blur-xl border-t border-dark-700 shrink-0 z-40 pb-safe <%= (room.settings && room.settings.locked && myRole !== 'admin' && myRole !== 'moderator') ? 'hidden' : 'block' %>">
        <form id="chatForm" class="flex items-end gap-2">
            <label class="p-3 mb-1 text-gray-400 hover:text-white transition cursor-pointer hover:bg-dark-800 rounded-full active:scale-95">
                <i data-lucide="paperclip" class="w-6 h-6"></i>
                <input type="file" id="fileInput" class="hidden">
            </label>
            
            <div class="flex-1 bg-dark-800 rounded-2xl border border-dark-700 focus-within:border-primary-500 focus-within:ring-1 focus-within:ring-primary-500 transition flex items-center min-h-[48px] px-4 py-2">
                <textarea id="msgInput" rows="1" class="w-full bg-transparent text-white text-sm focus:outline-none placeholder-gray-500 resize-none max-h-32 py-1" placeholder="Ketik pesan..."></textarea>
            </div>
            
            <button type="button" id="micBtn" class="p-3 mb-1 bg-dark-800 text-gray-400 rounded-full hover:text-white hover:bg-dark-700 transition active:scale-90 border border-dark-700">
                <i data-lucide="mic" class="w-6 h-6"></i>
            </button>

            <button type="submit" id="sendBtn" class="p-3 mb-1 bg-primary-600 hover:bg-primary-500 text-white rounded-full shadow-lg shadow-primary-600/30 transition transform active:scale-90 flex items-center justify-center">
                <i data-lucide="send" class="w-6 h-6 ml-0.5"></i>
            </button>
        </form>
    </div>

    <div id="lockedMsg" class="p-4 bg-dark-800 border-t border-dark-700 text-center z-40 <%= (room.settings && room.settings.locked && myRole !== 'admin' && myRole !== 'moderator') ? 'block' : 'hidden' %>">
        <p class="text-xs text-gray-400 uppercase tracking-widest font-bold flex items-center justify-center gap-2">
            <i data-lucide="lock" class="w-3 h-3"></i> Hanya Admin yang dapat mengirim pesan
        </p>
    </div>

    <div id="modalInfo" class="hidden fixed inset-0 bg-black/90 z-50 flex justify-end transition-opacity duration-300">
        <div class="w-full sm:w-3/4 bg-dark-800 h-full border-l border-dark-700 p-6 overflow-y-auto animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <button onclick="document.getElementById('modalInfo').classList.add('hidden')" class="mb-4 text-gray-400 flex items-center gap-2 hover:text-white transition">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Kembali
                </button>
            </div>
            
            <% if (room.type === 'group') { %>
                <div class="text-center mb-8 relative group/icon">
                    <div class="relative w-24 h-24 mx-auto mb-3">
                        <img src="<%= roomIcon %>" class="w-full h-full rounded-full border-4 border-dark-700 shadow-xl object-cover">
                        
                        <% if(myRole === 'admin') { %>
                            <label class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover/icon:opacity-100 transition cursor-pointer">
                                <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                                <input type="file" id="groupIconInput" class="hidden" accept="image/*">
                            </label>
                        <% } %>
                    </div>
                    <h2 class="text-xl font-bold text-white"><%= roomName %></h2>
                    
                    <% if(myRole === 'admin' || myRole === 'moderator') { %>
                        <div class="mt-4 bg-dark-900 p-3 rounded-xl border border-dark-700 text-left">
                            <label class="text-xs text-gray-400 block mb-2 font-bold flex items-center gap-2"><i data-lucide="clock" class="w-3 h-3"></i> Pesan Sementara</label>
                            <select onchange="setExpiry(this.value)" class="w-full bg-dark-800 text-white text-xs p-2.5 rounded-lg border border-dark-600 outline-none focus:border-primary-500 transition">
                                <option value="0" <%= (room.settings && room.settings.expiresIn === 0) ? 'selected' : '' %>>Mati (Simpan Selamanya)</option>
                                <option value="3600000" <%= (room.settings && room.settings.expiresIn === 3600000) ? 'selected' : '' %>>1 Jam</option>
                                <option value="86400000" <%= (room.settings && room.settings.expiresIn === 86400000) ? 'selected' : '' %>>24 Jam</option>
                                <option value="604800000" <%= (room.settings && room.settings.expiresIn === 604800000) ? 'selected' : '' %>>7 Hari</option>
                            </select>
                            <p class="text-[9px] text-gray-500 mt-1">Pesan akan dihapus otomatis setelah durasi ini.</p>
                        </div>

                        <div class="mt-4 bg-dark-900 p-4 rounded-xl flex items-center justify-between border border-dark-700 shadow-lg">
                            <div class="text-left">
                                <p class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="lock" class="w-4 h-4 text-primary-400"></i> Tutup Grup</p>
                                <p class="text-[10px] text-gray-500 mt-0.5">Hanya Admin/Mod yang bisa chat</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="lockSwitch" class="sr-only peer" <%= (room.settings && room.settings.locked) ? 'checked' : '' %> onchange="toggleLock(this)">
                                <div class="w-11 h-6 bg-dark-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600 border border-dark-600"></div>
                            </label>
                        </div>
                        
                        <button onclick="document.getElementById('modalAddMember').classList.remove('hidden')" class="w-full mt-3 bg-dark-700 hover:bg-dark-600 text-white py-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-2 shadow-lg">
                            <i data-lucide="user-plus" class="w-4 h-4"></i> Tambah Anggota
                        </button>
                    <% } %>

                    <div class="bg-dark-900 p-3 rounded-xl mt-4 border border-dark-700 flex justify-between items-center">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i data-lucide="link" class="w-4 h-4 text-gray-500 shrink-0"></i>
                            <span class="text-xs text-gray-400 truncate">/join-group/<%= room.inviteCode %></span>
                        </div>
                        <button class="p-2 bg-dark-800 rounded-lg hover:bg-dark-700 transition" onclick="navigator.clipboard.writeText(window.location.origin + '/join-group/<%= room.inviteCode %>'); alert('Link Copied!')">
                            <i data-lucide="copy" class="w-4 h-4 text-primary-400"></i>
                        </button>
                    </div>
                </div>

                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 mt-6 text-left">Anggota (<%= members.length %>)</h3>
                <div class="space-y-2">
                    <% members.forEach(m => { %>
                        <div class="flex items-center justify-between group bg-dark-900/50 p-3 rounded-xl border border-transparent hover:border-dark-700 transition">
                            <div class="flex items-center gap-3">
                                <img src="<%= m.pic %>" class="w-9 h-9 rounded-full bg-dark-800 object-cover">
                                <div>
                                    <p class="text-sm font-bold text-white flex items-center gap-1">
                                        <%= m.username %> 
                                        <% if(m.role === 'admin') { %> <i data-lucide="crown" class="w-3 h-3 text-red-500 fill-red-500"></i> <% } %>
                                        <% if(m.role === 'moderator') { %> <i data-lucide="shield" class="w-3 h-3 text-green-500 fill-green-500"></i> <% } %>
                                    </p>
                                    <p class="text-[10px] text-gray-500"><%= m.role.charAt(0).toUpperCase() + m.role.slice(1) %> <%= m.isOnline ? 'â€¢ Online' : '' %></p>
                                </div>
                            </div>
                            
                            <% if( (myRole === 'admin' || myRole === 'moderator') && m.userId !== user.id ) { %>
                                <div class="flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition">
                                    <% if(myRole === 'admin') { %>
                                        <% if(m.role !== 'admin') { %> <button onclick="action('<%= m.userId %>', 'promote_admin')" class="p-1.5 bg-red-500/10 text-red-500 rounded"><i data-lucide="crown" class="w-3 h-3"></i></button> <% } %>
                                        <% if(m.role === 'member') { %> <button onclick="action('<%= m.userId %>', 'promote_mod')" class="p-1.5 bg-green-500/10 text-green-500 rounded"><i data-lucide="shield" class="w-3 h-3"></i></button> <% } %>
                                        <% if(m.role === 'moderator') { %> <button onclick="action('<%= m.userId %>', 'demote')" class="p-1.5 bg-gray-500/10 text-gray-400 rounded"><i data-lucide="arrow-down" class="w-3 h-3"></i></button> <% } %>
                                    <% } %>
                                    <% if( !(myRole === 'moderator' && m.role === 'admin') ) { %>
                                        <button onclick="action('<%= m.userId %>', 'kick')" class="p-1.5 bg-dark-700 text-gray-400 rounded hover:bg-red-600 hover:text-white"><i data-lucide="user-x" class="w-3 h-3"></i></button>
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                    <% }) %>
                </div>
                
                <div class="mt-8 pt-4 border-t border-dark-700">
                    <button onclick="action('<%= user.id %>', 'leave')" class="w-full py-3 text-red-400 font-bold bg-red-500/10 rounded-xl hover:bg-red-500 hover:text-white flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar Grup</button>
                </div>

            <% } else if(room.type === 'private') { %>
                
                <div class="text-center mb-8">
                    <div class="relative w-24 h-24 mx-auto mb-3">
                        <img src="<%= roomIcon %>" class="w-full h-full rounded-full border-4 border-dark-700 shadow-xl object-cover">
                    </div>
                    <h2 class="text-xl font-bold text-white"><%= roomName %></h2>
                    
                    <div class="mt-4 bg-dark-900 p-3 rounded-xl border border-dark-700 text-left">
                        <label class="text-xs text-gray-400 block mb-2 font-bold flex items-center gap-2"><i data-lucide="clock" class="w-3 h-3"></i> Pesan Sementara</label>
                        <select onchange="setExpiry(this.value)" class="w-full bg-dark-800 text-white text-xs p-2.5 rounded-lg border border-dark-600 outline-none focus:border-primary-500 transition">
                            <option value="0" <%= (room.settings && room.settings.expiresIn === 0) ? 'selected' : '' %>>Mati (Simpan Selamanya)</option>
                            <option value="3600000" <%= (room.settings && room.settings.expiresIn === 3600000) ? 'selected' : '' %>>1 Jam</option>
                            <option value="86400000" <%= (room.settings && room.settings.expiresIn === 86400000) ? 'selected' : '' %>>24 Jam</option>
                            <option value="604800000" <%= (room.settings && room.settings.expiresIn === 604800000) ? 'selected' : '' %>>7 Hari</option>
                        </select>
                    </div>

                    <% const isBlocked = user.blocked && user.blocked.includes(targetUser.userId); %>
                    <button onclick="blockUser('<%= targetUser.userId %>', <%= !isBlocked %>)" 
                        class="w-full mt-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition <%= isBlocked ? 'bg-gray-700 text-white' : 'bg-red-600 text-white hover:bg-red-700' %>">
                        <i data-lucide="<%= isBlocked ? 'unlock' : 'ban' %>" class="w-4 h-4"></i> 
                        <%= isBlocked ? 'Buka Blokir' : 'Blokir User' %>
                    </button>
                </div>
            <% } %>
        </div>
    </div>

    <div id="modalAddMember" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-dark-800 w-full max-w-sm p-6 rounded-3xl border border-dark-700 h-[60vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5"></i> Tambah Anggota</h3>
                <button onclick="document.getElementById('modalAddMember').classList.add('hidden')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <input type="text" id="searchAdd" onkeyup="filterAddMember()" placeholder="Cari teman..." class="w-full bg-dark-900 text-white px-4 py-3 rounded-xl mb-4 text-xs outline-none border border-dark-700 focus:border-primary-500 transition">
            
            <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar" id="listAddMember">
                <% if(typeof contacts !== 'undefined' && contacts.length > 0) { %>
                    <% contacts.forEach(c => { %>
                        <div class="add-item flex justify-between items-center p-2 hover:bg-dark-700 rounded-xl group transition cursor-pointer" onclick="addMember('<%= c.id %>')">
                            <div class="flex items-center gap-3">
                                <img src="<%= c.profilePic || c.pic %>" class="w-8 h-8 rounded-full bg-dark-600 object-cover">
                                <span class="text-white text-sm font-bold add-name"><%= c.username %></span>
                            </div>
                            <button class="bg-primary-600 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p class="text-center text-xs text-gray-500 mt-4">Tidak ada teman tersedia untuk ditambahkan.</p>
                <% } %>
            </div>
        </div>
    </div>

    <div id="msgMenu" class="hidden fixed inset-0 z-[70] flex items-end sm:items-center sm:justify-center bg-black/60 backdrop-blur-sm" onclick="closeMsgMenu()">
        <div class="bg-dark-800 w-full sm:w-80 rounded-t-3xl sm:rounded-3xl border-t sm:border border-dark-700 p-4 animate-slide-up" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-gray-600 rounded-full mx-auto mb-4 sm:hidden"></div>
            <div class="space-y-1">
                <button onclick="menuReply()" class="w-full text-left p-3 text-white hover:bg-dark-700 rounded-xl flex gap-3 font-medium transition"><i data-lucide="reply" class="w-5 h-5"></i> Balas</button>
                
                <% if(myRole === 'admin' || myRole === 'moderator') { %>
                    <button onclick="menuPin()" class="w-full text-left p-3 text-white hover:bg-dark-700 rounded-xl flex gap-3 font-medium transition"><i data-lucide="pin" class="w-5 h-5"></i> Sematkan Pesan</button>
                <% } %>
                
                <button id="btnCopy" onclick="menuCopy()" class="w-full text-left p-3 text-white hover:bg-dark-700 rounded-xl flex gap-3 font-medium transition"><i data-lucide="copy" class="w-5 h-5"></i> Salin Teks</button>
            </div>
        </div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[80] bg-black flex items-center justify-center p-2" onclick="this.classList.add('hidden')">
        <img id="imgFull" src="" class="max-w-full max-h-full rounded-lg shadow-2xl">
    </div>

</div>

<script>
    lucide.createIcons();
    const socket = io({ query: { userId: '<%= user.id %>' } });
    const roomId = "<%= room.id %>";
    const myId = "<%= user.id %>";
    let selectedMsg = null;
    let currentAction = null;

    // --- SOCKET LOGIC ---
    socket.emit('join_room', {roomId});
    socket.on('receive_message', renderMessage);
    
    // Update Pin
    socket.on('update_pin', (msg) => {
        const bar = document.getElementById('pinnedBar');
        const content = document.getElementById('pinnedContent');
        const container = document.getElementById('messages');
        if(msg) {
            bar.classList.replace('hidden', 'flex');
            content.innerText = msg.type === 'text' ? msg.content : 'Media File';
            container.style.paddingTop = '60px';
        } else {
            bar.classList.replace('flex', 'hidden');
            container.style.paddingTop = '16px';
        }
    });

    // Update Lock
    socket.on('group_locked', (isLocked) => {
        const role = "<%= myRole %>";
        const inputArea = document.getElementById('inputArea');
        const lockedMsg = document.getElementById('lockedMsg');
        const switchEl = document.getElementById('lockSwitch');
        if(switchEl) switchEl.checked = isLocked;
        if(role !== 'admin' && role !== 'moderator') {
            if(isLocked) { inputArea.classList.add('hidden'); lockedMsg.classList.remove('hidden'); }
            else { inputArea.classList.remove('hidden'); lockedMsg.classList.add('hidden'); }
        }
    });

    socket.on('block_updated', () => location.reload());
    socket.on('expiry_updated', (dur) => location.reload()); // Refresh UI timer
    socket.on('refresh_members', () => location.reload());
    socket.on('force_redirect', (url) => window.location = url);
    socket.on('display_typing', ({username, isTyping}) => {
        const ind = document.getElementById('typingIndicator');
        if(isTyping) ind.classList.remove('hidden'); else ind.classList.add('hidden');
    });

    // --- RENDER MESSAGE ---
    function renderMessage(msg) {
        if (msg.type === 'system') {
            const div = document.createElement('div');
            div.className = "flex justify-center my-4 w-full px-4";
            div.innerHTML = `
                <div class="bg-dark-800/80 backdrop-blur-sm text-gray-400 text-[10px] px-3 py-1.5 rounded-full border border-dark-700 font-medium tracking-wide shadow-sm text-center leading-relaxed max-w-[85%]">
                    ${msg.content}
                </div>`;
            document.getElementById('messages').appendChild(div);
            scrollToBottom();
            return;
        }

        const isMe = msg.userId === myId;
        const div = document.createElement('div');
        const bubbleColor = isMe ? 'bg-primary-600 text-white' : 'bg-dark-800 text-gray-100 border border-dark-700';
        
        let contentText = msg.content;
        // Fix Preview Image
        if(msg.type === 'image') contentText = `<img src="${msg.content}" onclick="event.stopPropagation(); viewImage('${msg.content}')" class="rounded-lg max-h-60 w-full object-cover cursor-pointer hover:opacity-90 transition">`;
        else if(msg.type === 'audio') contentText = `<audio src="${msg.content}" controls class="w-[200px]"></audio>`;
        
        div.innerHTML = `
        <div class="message-row w-full flex ${isMe?'justify-end':'justify-start'} mb-2 relative select-none group" 
             onclick="openMsgOption(this, '${msg.id}', '${msg.content.replace(/'/g, "\\'")}', '${msg.type}', '${msg.username}')">
            
            <div class="message-content relative z-10 flex max-w-[95%] ${isMe?'flex-row-reverse':'flex-row'} items-end gap-2">
                ${!isMe ? `<img src="${msg.pic}" class="w-6 h-6 rounded-full mb-1 border border-dark-700 object-cover shrink-0">` : ''}
                
                <div class="flex flex-col ${isMe?'items-end':'items-start'} min-w-0 flex-1">
                    ${!isMe ? `<span class="text-[10px] text-primary-400 font-bold ml-1 mb-0.5">${msg.username}</span>` : ''}
                    
                    <div class="relative px-3 py-2 shadow-sm ${isMe?'rounded-2xl rounded-tr-sm':'rounded-2xl rounded-tl-sm'} ${bubbleColor} w-fit max-w-full break-words">
                        ${msg.replyTo ? `<div class="mb-1 p-1.5 pl-2 border-l-2 border-white/50 bg-black/10 rounded text-[10px]"><span class="font-bold opacity-80">${msg.replyTo.username}</span><p class="truncate opacity-70">${msg.replyTo.content}</p></div>` : ''}
                        <div class="text-sm leading-relaxed whitespace-pre-wrap">${contentText}</div>
                    </div>
                    
                    <span class="text-[9px] text-gray-500 opacity-70 mt-0.5 ml-1 flex gap-1 items-center">
                        ${msg.time} ${isMe ? '<i data-lucide="check-check" class="w-3 h-3 text-gray-500"></i>' : ''}
                    </span>
                </div>
            </div>
        </div>`;
        document.getElementById('messages').appendChild(div);
        lucide.createIcons();
        scrollToBottom();
    }

    // --- SWIPE TO REPLY ---
    const messagesContainer = document.getElementById('messages');
    let touchStartX = 0;
    let swipingElement = null;

    messagesContainer.addEventListener('touchstart', (e) => {
        const row = e.target.closest('.message-row');
        if(!row) return;
        touchStartX = e.touches[0].clientX;
        swipingElement = row.querySelector('.message-content');
        if(swipingElement) swipingElement.style.transition = 'none';
    }, {passive: true});

    messagesContainer.addEventListener('touchmove', (e) => {
        if(!swipingElement) return;
        const diff = e.touches[0].clientX - touchStartX;
        if(diff > 0 && diff < 150) {
            swipingElement.style.transform = `translateX(${diff * 0.5}px)`; 
        }
    }, {passive: true});

    messagesContainer.addEventListener('touchend', (e) => {
        if(!swipingElement) return;
        const diff = e.changedTouches[0].clientX - touchStartX;
        swipingElement.style.transition = 'transform 0.3s ease-out';
        swipingElement.style.transform = 'translateX(0)';
        if(diff > 60) swipingElement.closest('.message-row').click();
        swipingElement = null;
    });

    // --- MENU ACTIONS ---
    function openMsgOption(el, id, content, type, username) {
        selectedMsg = { id, content, type, username };
        const menu = document.getElementById('msgMenu');
        const btnCopy = document.getElementById('btnCopy');
        
        // FIX: Sembunyikan 'Salin Teks' jika tipe bukan 'text'
        if(type !== 'text') {
            btnCopy.classList.add('hidden');
        } else {
            btnCopy.classList.remove('hidden');
        }
        
        menu.classList.remove('hidden');
    }
    function closeMsgMenu() { document.getElementById('msgMenu').classList.add('hidden'); selectedMsg = null; }
    
    function menuReply() { setAction('reply', selectedMsg); closeMsgMenu(); }
    function menuPin() { socket.emit('pin_message', { roomId, msgId: selectedMsg.id, userId: myId }); closeMsgMenu(); }
    function menuCopy() { navigator.clipboard.writeText(selectedMsg.content); closeMsgMenu(); alert('Disalin!'); }
    function unpinMessage(e) { e.stopPropagation(); socket.emit('unpin_message', { roomId, userId: myId }); }
    function toggleLock(el) { socket.emit('toggle_group_lock', { roomId, isLocked: el.checked, userId: myId }); }
    function setExpiry(val) { socket.emit('set_expiry', { roomId, duration: parseInt(val) }); }
    function blockUser(tid, block) { socket.emit('block_user', { targetId: tid, userId: myId, isBlocked: block }); }
    function viewImage(src) { document.getElementById('imgFull').src=src; document.getElementById('imgModal').classList.remove('hidden'); }

    // --- HELPERS ---
    function setAction(type, data) {
        currentAction = { type, id: data.id, data: type === 'reply' ? data : null };
        document.getElementById('previewBar').classList.remove('hidden');
        document.getElementById('previewText').innerText = data.content;
        document.getElementById('msgInput').focus();
    }
    function cancelAction() { currentAction = null; document.getElementById('previewBar').classList.add('hidden'); }
    function scrollToBottom() { const m = document.getElementById('messages'); m.scrollTop = m.scrollHeight; }
    function openInfoModal() { document.getElementById('modalInfo').classList.remove('hidden'); }
    function action(tid, act) { socket.emit('group_action', {roomId, targetId:tid, action:act, executorId:myId}); }
    function addMember(tid) { socket.emit('add_member', {roomId, targetId:tid, executorId:myId}); document.getElementById('modalAddMember').classList.add('hidden'); }
    function filterAddMember() {
        const filter = document.getElementById('searchAdd').value.toLowerCase();
        const items = document.getElementsByClassName('add-item');
        for (let i = 0; i < items.length; i++) { const txt = items[i].getElementsByClassName('add-name')[0].innerText; items[i].style.display = txt.toLowerCase().includes(filter) ? "" : "none"; }
    }

    // --- SEND MESSAGE ---
    const textarea = document.getElementById('msgInput');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
        const micBtn = document.getElementById('micBtn');
        
        if(this.value.trim().length > 0) {
            socket.emit('typing', {roomId, username: '<%= user.username %>', isTyping: true});
            micBtn.classList.add('hidden');
        } else {
            socket.emit('typing', {roomId, username: '<%= user.username %>', isTyping: false});
            micBtn.classList.remove('hidden');
        }
    });

    document.getElementById('chatForm').addEventListener('submit', (e) => {
        e.preventDefault(); const text = document.getElementById('msgInput').value; if(!text.trim()) return;
        socket.emit('send_message', { roomId, userId: myId, type: 'text', content: text, replyTo: currentAction?.data });
        document.getElementById('msgInput').value = ''; 
        document.getElementById('micBtn').classList.remove('hidden');
        cancelAction();
    });

    // --- VOICE & UPLOAD ---
    const micBtn = document.getElementById('micBtn');
    if(micBtn) {
        micBtn.addEventListener('mousedown', startRec); micBtn.addEventListener('mouseup', stopRec);
        micBtn.addEventListener('touchstart', startRec); micBtn.addEventListener('touchend', stopRec);
    }
    function startRec(e) { e.preventDefault(); navigator.mediaDevices.getUserMedia({audio:true}).then(s => { mediaRecorder=new MediaRecorder(s); mediaRecorder.start(); audioChunks=[]; isRecording=true; micBtn.classList.add('bg-red-500','text-white'); mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=()=>uploadFile(new File([new Blob(audioChunks)], "vn.webm")); }); }
    function stopRec(e) { e.preventDefault(); if(isRecording && mediaRecorder) { mediaRecorder.stop(); isRecording=false; micBtn.classList.remove('bg-red-500','text-white'); } }
    
    const fileInp = document.getElementById('fileInput');
    if(fileInp) { fileInp.addEventListener('change', e => uploadFile(e.target.files[0])); }
    
    async function uploadFile(file) {
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch('/chat/upload', {method:'POST', body:fd});
        const d = await res.json();
        if(d.success) socket.emit('send_message', {roomId, userId:myId, type:d.type, content:d.filePath, fileName:d.fileName});
    }

    // FIX: UPLOAD GRUP ICON (TRIGGER VIA JS)
    const grpInput = document.getElementById('groupIconInput');
    if(grpInput) { 
        grpInput.addEventListener('change', async (e) => { 
            const fd = new FormData(); 
            fd.append('groupIcon', e.target.files[0]); 
            fd.append('roomId', roomId); 
            const res = await fetch('/chat/update-group-icon', { method: 'POST', body: fd }); 
            if((await res.json()).success) location.reload(); 
        }); 
    }

    scrollToBottom();
</script>
<%- include('partials/system_scripts') %>
<%- include('partials/broadcast_modal') %>
</body>
</html>